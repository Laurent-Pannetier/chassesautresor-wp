<?php
defined( 'ABSPATH' ) || exit;

// ==================================================
// üìö SOMMAIRE DU FICHIER
// ==================================================
//
// 1. üì¶ FONCTIONNALIT√âS ADMINISTRATEUR
// 2. üì¶ TAUX DE CONVERSION & PAIEMENT
// 3. üì¶ R√âINITIALISATION
// 4. üõ†Ô∏è D√âVELOPPEMENT
//


// ==================================================
// üì¶ FONCTIONNALIT√âS ADMINISTRATEUR
// ==================================================
/**
 * üîπ rechercher_utilisateur_ajax ‚Üí Rechercher des utilisateurs en AJAX pour l‚Äôautocompl√©tion.
 * üîπ traiter_gestion_points ‚Üí G√©rer l‚Äôajout ou le retrait de points √† un utilisateur.
 * üîπ charger_script_autocomplete_utilisateurs ‚Üí Enregistrer et charger le script de gestion des points dans l‚Äôadmin (page "Mon Compte").
 * üîπ gerer_organisateur ‚Üí G√©rer l‚Äôacceptation ou le refus d‚Äôun organisateur (demande mod√©ration).
 */

 
/**
 * üìå Recherche d'utilisateurs en AJAX pour l'autocompl√©tion.
 *
 * - Recherche sur `user_login`, `display_name`, et `user_email`.
 * - Aucun filtre par r√¥le : tous les utilisateurs sont inclus.
 * - V√©rification des permissions (`administrator` requis).
 * - Retour JSON des r√©sultats.
 */
function rechercher_utilisateur_ajax() {
    // ‚úÖ V√©rifier que la requ√™te est bien envoy√©e par un administrateur
    if (!current_user_can('administrator')) {
        wp_send_json_error(['message' => '‚õî Acc√®s refus√©.']);
    }

    // ‚úÖ V√©rifier la pr√©sence du param√®tre de recherche
    $search = isset($_GET['term']) ? sanitize_text_field($_GET['term']) : '';

    if (empty($search)) {
        wp_send_json_error(['message' => '‚ùå Requ√™te vide.']);
    }

    // ‚úÖ Requ√™te pour r√©cup√©rer tous les utilisateurs sans restriction de r√¥le
    $users = get_users([
        'search'         => '*' . esc_attr($search) . '*',
        'search_columns' => ['user_login', 'display_name', 'user_email']
    ]);

    // ‚úÖ V√©rifier que des utilisateurs sont trouv√©s
    if (empty($users)) {
        wp_send_json_error(['message' => '‚ùå Aucun utilisateur trouv√©.']);
    }

    // ‚úÖ Formatage des r√©sultats en JSON
    $results = [];
    foreach ($users as $user) {
        $results[] = [
            'id'   => $user->ID,
            'text' => esc_html($user->display_name) . ' (' . esc_html($user->user_login) . ')'
        ];
    }

    wp_send_json_success($results);
}
add_action('wp_ajax_rechercher_utilisateur', 'rechercher_utilisateur_ajax');

/**
 * üìå G√®re l'ajout ou le retrait de points √† un utilisateur.
 */
function traiter_gestion_points() {
    
    if ($_SERVER['REQUEST_METHOD'] !== 'POST' || !isset($_POST['modifier_points'])) {
        return;
    }
    
    // ‚úÖ V√©rification du nonce pour la s√©curit√©
    if (!isset($_POST['gestion_points_nonce']) || !wp_verify_nonce($_POST['gestion_points_nonce'], 'gestion_points_action')) {
        wp_die('‚ùå V√©rification du nonce √©chou√©e.');
    }

    // ‚úÖ V√©rification que l'utilisateur est administrateur
    if (!current_user_can('administrator')) {
        wp_die('‚ùå Acc√®s refus√©.');
    }

    // ‚úÖ V√©rification et assainissement des donn√©es
    $utilisateur = sanitize_text_field($_POST['utilisateur']);
    $type_modification = sanitize_text_field($_POST['type_modification']);
    $nombre_points = intval($_POST['nombre_points']);

    if (!$utilisateur || !$type_modification || $nombre_points <= 0) {
        wp_die('‚ùå Donn√©es invalides.');
    }

    // R√©cup√©rer l'ID de l'utilisateur
    $user = get_user_by('ID', intval($utilisateur));
    if (!$user) {
        wp_die('‚ùå Utilisateur introuvable.');
    }

    $user_id = $user->ID;
    $solde_actuel = get_user_points($user_id) ?: 0;

    // Modification des points selon l‚Äôaction choisie
    if ($type_modification === "ajouter") {
        $nouveau_solde = $solde_actuel + $nombre_points;
    } elseif ($type_modification === "retirer") {
        if ($nombre_points > $solde_actuel) {
            wp_die('‚ùå Impossible de retirer plus de points que l‚Äôutilisateur en poss√®de.');
        }
        $nouveau_solde = $solde_actuel - $nombre_points;
    } else {
        wp_die('‚ùå Action invalide.');
    }

    // Mettre √† jour les points de l'utilisateur
    update_user_points($user_id, $nouveau_solde);

    error_log("‚úÖ Points modifi√©s : $nombre_points $type_modification pour l'utilisateur $utilisateur");

    // ‚úÖ Redirection apr√®s soumission
    wp_redirect(add_query_arg('points_modifies', '1', wp_get_referer()));
    exit;
}
add_action('init', 'traiter_gestion_points');


/**
 * Enregistre et charge le script de gestion des points pour les administrateurs sur la page "Mon Compte".
 *
 * Cette fonction :
 * - Charge le script `gestion-points.js` uniquement sur la page "Mon Compte".
 * - S'assure que l'utilisateur est un administrateur avant d'ajouter le script.
 * - Utilise `wp_localize_script()` pour rendre l'URL d'AJAX accessible au script JS.
 *
 * @return void
 */
function charger_script_autocomplete_utilisateurs() {
    // V√©rifier si l'on est sur la page "Mon Compte" et que l'utilisateur est administrateur
    if (is_page('mon-compte') && current_user_can('administrator')) {
        wp_enqueue_script(
            'autocomplete-utilisateurs', // Nouveau nom du script
            get_stylesheet_directory_uri() . '/assets/js/autocomplete-utilisateurs.js',
            [], // Pas de d√©pendances sp√©cifiques
            filemtime(get_stylesheet_directory() . '/assets/js/autocomplete-utilisateurs.js'),
            true // Chargement en footer
        );

        // Rendre l'URL AJAX disponible pour le script
        wp_localize_script('autocomplete-utilisateurs', 'ajax_object', [
            'ajax_url' => admin_url('admin-ajax.php')
        ]);
    }
}
add_action('wp_enqueue_scripts', 'charger_script_autocomplete_utilisateurs');

// Fonction principale pour g√©rer l'acceptation ou le refus
function gerer_organisateur() {
    
    // V√©rification des permissions et nonce
    check_ajax_referer('gerer_organisateur_nonce', 'security');
    

    if (!current_user_can('manage_options')) {
        wp_send_json_error(array("message" => "Permission refus√©e."));
        exit;
    }

    $post_id = intval($_POST['post_id']);
    $type = sanitize_text_field($_POST['type']);

    if (!$post_id || empty($type)) {
        wp_send_json_error(array("message" => "Requ√™te invalide."));
        exit;
    }

    if ($type === "accepter") {
        // Mise √† jour du statut de l'organisateur
        wp_update_post(array(
            'ID'          => $post_id,
            'post_status' => 'publish'
        ));

        // Attribution du r√¥le "Organisateur" √† l'auteur de la demande
        $user_id = get_post_field('post_author', $post_id);
        if ($user_id) {
            $user = new WP_User($user_id);
            $user->set_role('organisateur'); // Assurez-vous que ce r√¥le existe
        }

        // Envoi d'un email de confirmation
        $email = get_post_meta($post_id, 'email_organisateur', true);
        if (!empty($email)) {
            wp_mail($email, "Validation de votre inscription", "Votre demande d'organisateur a √©t√© valid√©e !");
        }

        wp_send_json_success(array("message" => "Organisateur accept√©."));
    }

    if ($type === "refuser") {
        // Suppression de la demande
        wp_delete_post($post_id, true);

        // Envoi d'un email de refus
        $email = get_post_meta($post_id, 'email_organisateur', true);
        if (!empty($email)) {
            wp_mail($email, "Refus de votre demande", "Votre demande d'organisateur a √©t√© refus√©e.");
        }

        wp_send_json_success(array("message" => "Demande refus√©e et supprim√©e."));
    }

    wp_send_json_error(array("message" => "Action inconnue."));
}



// ==================================================
// üì¶ TAUX DE CONVERSION & PAIEMENT
// ==================================================
/**
 * üîπ acf_add_local_field_group (conditionnelle) ‚Üí Ajouter dynamiquement le champ ACF pour le taux de conversion.
 * üîπ init_taux_conversion ‚Üí Initialiser le taux de conversion par d√©faut s‚Äôil n‚Äôexiste pas.
 * üîπ get_taux_conversion_actuel ‚Üí R√©cup√©rer le taux de conversion actuel.
 * üîπ update_taux_conversion ‚Üí Mettre √† jour le taux de conversion et enregistrer l‚Äôhistorique.
 * üîπ charger_script_taux_conversion ‚Üí Charger le script `taux-conversion.js` uniquement pour les administrateurs sur "Mon Compte".
 * üîπ traiter_mise_a_jour_taux_conversion ‚Üí Mettre √† jour le taux de conversion depuis l‚Äôadministration.
 * üîπ afficher_tableau_paiements_admin ‚Üí Afficher les demandes de paiement (en attente ou r√©gl√©es) pour les administrateurs.
 * üîπ regler_paiement_admin ‚Üí Traiter le r√®glement d‚Äôune demande de paiement depuis l‚Äôadmin.
 * üîπ traiter_demande_paiement ‚Üí Traiter la demande de conversion de points en euros pour un organisateur.
 * üîπ $_SERVER['REQUEST_METHOD'] === 'POST' && isset(...) ‚Üí Mettre √† jour le statut des demandes de paiement (admin).
 */

/**
 * üìå Ajout du champ d'administration pour le taux de conversion
 */
add_action('acf/init', function () {
    acf_add_local_field_group([
        'key' => 'group_taux_conversion',
        'title' => 'Param√®tres de Conversion',
        'fields' => array(
            array(
                'key' => 'field_taux_conversion',
                'label' => 'Taux de conversion actuel',
                'name' => 'taux_conversion',
                'type' => 'number',
                'instructions' => 'Indiquez le taux de conversion des points en euros (ex : 0.05 pour 1 point = 0.05‚Ç¨).',
                'default_value' => 0.05,
                'step' => 0.001,
                'required' => true,
            ),
        ),
        'location' => array(
            array(
                array(
                    'param' => 'options_page',
                    'operator' => '==',
                    'value' => 'options_taux_conversion',
                ),
            ),
        ),
    ]);
});


/**
 * üìå Initialise le taux de conversion par d√©faut s'il n'existe pas.
 */
function init_taux_conversion() {
    if (get_option('taux_conversion') === false) {
        update_option('taux_conversion', 85);
    }
}
add_action('init', 'init_taux_conversion');

/**
 * üìå R√©cup√®re le taux de conversion actuel.
 *
 * @return float Le dernier taux enregistr√©, 85 par d√©faut.
 */
function get_taux_conversion_actuel() {
    return floatval(get_option('taux_conversion', 85));
}

/**
 * üìå Met √† jour le taux de conversion et enregistre l'historique.
 *
 * @param float $nouveau_taux Nouvelle valeur du taux de conversion.
 */
function update_taux_conversion($nouveau_taux) {
    $historique = get_option('historique_taux_conversion', []);

    // Ajouter la nouvelle entr√©e dans l'historique
    $historique[] = [
        'date_taux_conversion' => current_time('mysql'),
        'valeur_taux_conversion' => floatval($nouveau_taux)
    ];

    // Limiter l'historique √† 10 entr√©es pour √©viter une surcharge inutile
    if (count($historique) > 10) {
        array_shift($historique);
    }

    update_option('taux_conversion', floatval($nouveau_taux));
    update_option('historique_taux_conversion', $historique);
}
/**
 * üìå Charge le script `taux-conversion.js` uniquement pour les administrateurs sur "Mon Compte" et ses sous-pages (y compris les templates redirig√©s).
 *
 * - V√©rifie si l'URL commence par "/mon-compte/" pour inclure toutes les pages et templates associ√©s.
 * - V√©rifie si l'utilisateur a le r√¥le d'administrateur (`current_user_can('administrator')`).
 * - Si les deux conditions sont remplies, charge le script `taux-conversion.js`.
 */
function charger_script_taux_conversion() {
    if (is_page('mon-compte') && current_user_can('administrator')) {
        wp_enqueue_script(
            'taux-conversion',
            get_stylesheet_directory_uri() . '/assets/js/taux-conversion.js',
            [],
            filemtime(get_stylesheet_directory() . '/assets/js/taux-conversion.js'),
            true
        );
    }
}
add_action('wp_enqueue_scripts', 'charger_script_taux_conversion');

/**
 * üìå Met √† jour le taux de conversion depuis l'administration.
 */
function traiter_mise_a_jour_taux_conversion() {
    if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['enregistrer_taux'])) {
        
        // V√©rifier le nonce pour la s√©curit√©
        if (!isset($_POST['modifier_taux_conversion_nonce']) || !wp_verify_nonce($_POST['modifier_taux_conversion_nonce'], 'modifier_taux_conversion_action')) {
            wp_die('‚ùå V√©rification du nonce √©chou√©e.');
        }

        // V√©rifier que l'utilisateur est bien un administrateur
        if (!current_user_can('administrator')) {
            wp_die('‚ùå Acc√®s refus√©.');
        }

        // V√©rifier et assainir la valeur entr√©e
        $nouveau_taux = isset($_POST['nouveau_taux']) ? floatval($_POST['nouveau_taux']) : null;
        if ($nouveau_taux === null || $nouveau_taux <= 0) {
            wp_die('‚ùå Veuillez entrer un taux de conversion valide.');
        }

        // Mettre √† jour le taux dans les options WordPress
        update_option('taux_conversion', $nouveau_taux);

        // Ajouter l'ancien taux √† l'historique
        $historique = get_option('historique_taux_conversion', []);
        $historique[] = [
            'date_taux_conversion' => current_time('mysql'),
            'valeur_taux_conversion' => $nouveau_taux
        ];
        
        // Limiter l'historique √† 10 entr√©es pour √©viter une surcharge
        if (count($historique) > 10) {
            array_shift($historique);
        }

        update_option('historique_taux_conversion', $historique);

        // Rediriger avec un message de confirmation
        wp_redirect(add_query_arg('taux_mis_a_jour', '1', wp_get_referer()));
        exit;
    }
}

/**
 * üìå Affiche les demandes de paiement en attente et r√©gl√©es pour les administrateurs.
 */
function afficher_tableau_paiements_admin() {
    if (!current_user_can('administrator')) {
        return;
    }

    // R√©cup√©rer tous les utilisateurs ayant une demande de paiement
    $users = get_users(['meta_key' => 'demande_paiement', 'meta_compare' => 'EXISTS']);

    if (empty($users)) {
        echo '<p>Aucune demande de paiement en attente.</p>';
        return;
    }

    echo '<table class="widefat fixed">';
    echo '<thead><tr><th>Organisateur</th><th>Montant / Points</th><th>Date demande</th><th>IBAN / BIC</th><th>Statut</th><th>Action</th></tr></thead>';
    echo '<tbody>';

    foreach ($users as $user) {
        $paiements = get_user_meta($user->ID, 'demande_paiement', true);
        $paiements = maybe_unserialize($paiements);

        // R√©cup√©rer l'ID du CPT "organisateur" associ√© √† l'utilisateur
        $organisateur_id = get_organisateur_from_user($user->ID);
        $iban = $organisateur_id ? get_field('gagnez_de_largent_iban', $organisateur_id) : 'Non renseign√©';
        $bic = $organisateur_id ? get_field('gagnez_de_largent_bic', $organisateur_id) : '';

        foreach ($paiements as $index => $paiement) {
            $statut = $paiement['statut'] === 'regl√©' ? '‚úÖ R√©gl√©' : 'üü° En attente';
            $action = $paiement['statut'] === 'en attente' 
                ? '<a href="' . add_query_arg(['regler_paiement' => $index, 'user_id' => $user->ID]) . '" class="button">‚úÖ R√©gler</a>' 
                : '-';

            $points_utilises = isset($paiement['paiement_points_utilises']) ? esc_html($paiement['paiement_points_utilises']) : 'N/A';

            echo '<tr>';
            echo '<td>' . esc_html($user->display_name) . '</td>';
            echo '<td>' . esc_html($paiement['paiement_demande_montant']) . ' ‚Ç¨<br><small>(' . $points_utilises . ' points)</small></td>';
            echo '<td>' . esc_html(date('Y-m-d H:i', strtotime($paiement['paiement_date_demande']))) . '</td>';
            echo '<td><strong>' . esc_html($iban) . '</strong><br><small>' . esc_html($bic) . '</small></td>';
            echo '<td>' . esc_html($statut) . '</td>';
            echo '<td>' . $action . '</td>';
            echo '</tr>';
        }
    }

    echo '</tbody></table>';
}

/**
 * üìå Traite le r√®glement d'une demande de paiement depuis l'admin.
 */
function regler_paiement_admin() {
    // V√©rifier que l'utilisateur est administrateur et que les param√®tres sont pr√©sents
    if (!current_user_can('administrator') || !isset($_GET['regler_paiement']) || !isset($_GET['user_id'])) {
        return; // S√©curit√© : seul un admin peut traiter un paiement
    }

    $user_id = intval($_GET['user_id']);
    $index = intval($_GET['regler_paiement']);

    // R√©cup√©rer les paiements
    $paiements = get_user_meta($user_id, 'demande_paiement', true);
    if (empty($paiements) || !isset($paiements[$index])) {
        error_log("‚ùå Erreur : Paiement non trouv√© pour user_id=$user_id, index=$index");
        return;
    }

    error_log("üõ†Ô∏è Paiements AVANT mise √† jour : " . print_r($paiements, true));

    // Mise √† jour du statut du paiement
    $paiements[$index]['statut'] = 'regl√©';
    $paiements[$index]['paiement_date_reglement'] = current_time('mysql');

    // Enregistrement de la mise √† jour
    $update_success = update_user_meta($user_id, 'demande_paiement', $paiements);

    error_log("‚úÖ Paiement r√©gl√© pour user_id=$user_id, index=$index");

    // V√©rification apr√®s mise √† jour
    $paiements_apres = get_user_meta($user_id, 'demande_paiement', true);
    error_log("üõ†Ô∏è Paiements APR√àS mise √† jour : " . print_r($paiements_apres, true));

    if (!$update_success) {
        error_log("‚ùå ERREUR : La mise √† jour des paiements a √©chou√© !");
    }

    // Rediriger pour √©viter de re-traiter la requ√™te en cas de rechargement
    wp_redirect(remove_query_arg(['regler_paiement', 'user_id']));
    exit;
}
// Enregistrement de la fonction sur le hook admin
add_action('template_redirect', 'regler_paiement_admin');

/**
 * üí∂ Traiter la demande de conversion de points en euros pour un organisateur.
 *
 * Cette fonction s'ex√©cute lors de l'envoi d'un formulaire en POST contenant le champ `demander_paiement`.
 * Elle permet √† un utilisateur connect√© de :
 * - V√©rifier un nonce de s√©curit√© (`demande_paiement_nonce`).
 * - V√©rifier qu‚Äôil a suffisamment de points pour effectuer la conversion.
 * - Calculer le montant en euros selon le taux de conversion courant.
 * - Enregistrer la demande dans sa m√©ta `demande_paiement`.
 * - D√©duire les points convertis de son solde.
 * - Envoyer une notification par email √† l‚Äôadministrateur.
 * - Rediriger l‚Äôutilisateur vers la page pr√©c√©dente avec un param√®tre de confirmation.
 *
 * üí° Le seuil minimal de conversion est de 500 points.
 * üí° Le taux de conversion est r√©cup√©r√© via `get_taux_conversion_actuel()`.
 *
 * @return void
 *
 * @hook init
 */
function traiter_demande_paiement() {
    if ($_SERVER['REQUEST_METHOD'] !== 'POST' || !isset($_POST['demander_paiement'])) {
        return; // üö´ Ne rien faire si ce n'est pas une requ√™te POST valide
    }

    // ‚úÖ V√©rification du nonce pour la s√©curit√©
    if (!isset($_POST['demande_paiement_nonce']) || !wp_verify_nonce($_POST['demande_paiement_nonce'], 'demande_paiement_action')) {
        wp_die('‚ùå V√©rification du nonce √©chou√©e.');
    }

    // ‚úÖ V√©rification de l'utilisateur connect√©
    if (!is_user_logged_in()) {
        wp_die('‚ùå Vous devez √™tre connect√© pour effectuer cette action.');
    }

    $user_id = get_current_user_id();
    $solde_actuel = get_user_points($user_id) ?: 0;
    $taux_conversion = get_taux_conversion_actuel();

    // ‚úÖ V√©rification du nombre de points demand√©s
    $points_a_convertir = isset($_POST['points_a_convertir']) ? intval($_POST['points_a_convertir']) : 0;

    if ($points_a_convertir < 500) {
        wp_die('‚ùå Le minimum pour une conversion est de 500 points.');
    }

    if ($points_a_convertir > $solde_actuel) {
        wp_die('‚ùå Vous n\'avez pas assez de points pour effectuer cette conversion.');
    }

    // ‚úÖ Calcul du montant en euros
    $montant_euros = round(($points_a_convertir / 1000) * $taux_conversion, 2);

    // üìå R√©cup√©ration des demandes existantes et ajout de la nouvelle
    $paiements = get_user_meta($user_id, 'demande_paiement', true) ?: [];
    $paiements = maybe_unserialize($paiements);

    $nouvelle_demande = [
        'paiement_date_demande' => current_time('mysql'),
        'paiement_demande_montant' => $montant_euros,
        'paiement_points_utilises' => $points_a_convertir, // ‚úÖ AJOUT DU STOCKAGE DES POINTS
        'paiement_date_reglement' => '',
        'statut' => 'en attente'
    ];

    $paiements[] = $nouvelle_demande;

    // ‚úÖ Enregistrement de la demande et mise √† jour des points de l'utilisateur
    update_user_meta($user_id, 'demande_paiement', $paiements);
    update_user_points($user_id, -$points_a_convertir);

    error_log("‚úÖ Demande enregistr√©e : " . json_encode($nouvelle_demande));

    // üìß Notification admin
    $admin_email = get_option('admin_email');
    $subject = "Nouvelle demande de paiement";
    $message = "Une nouvelle demande de paiement a √©t√© soumise.\n\n";
    $message .= "Organisateur ID : $user_id\n";
    $message .= "Montant : {$montant_euros} ‚Ç¨\n";
    $message .= "Points utilis√©s : {$points_a_convertir} points\n"; // ‚úÖ AJOUT√â DANS LE MAIL
    $message .= "Date : " . current_time('mysql') . "\n";
    $message .= "Statut : En attente";

    wp_mail($admin_email, $subject, $message);
    error_log("üìß Notification envoy√©e √† l'administrateur.");

    // ‚úÖ Redirection apr√®s soumission
    wp_redirect(add_query_arg('paiement_envoye', '1', wp_get_referer()));
    exit;
}
add_action('init', 'traiter_demande_paiement');

// ----------------------------------------------------------
// üéõÔ∏è Mise √† jour du statut des demandes de paiement (Admin)
// ----------------------------------------------------------
//
// - Cette fonction permet √† l'administrateur de modifier le statut d'une demande.
// - Le statut peut √™tre mis √† "En attente" ou "R√©gl√©".
// - Si le statut passe √† "R√©gl√©", la date de r√®glement est enregistr√©e.
// - L'enregistrement se fait apr√®s un clic sur le bouton "Enregistrer" du formulaire.
//
// üìå O√π est utilis√© ce code ?
/*
  - Dans le shortcode [demandes_paiement] (affichage du tableau des demandes)
  - Formulaire avec liste d√©roulante pour modifier le statut
*/
//
// üîç Comment le retrouver rapidement ?
// üëâ Rechercher "üéõÔ∏è Mise √† jour du statut des demandes de paiement"
//

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['modifier_statut'], $_POST['paiement_id'], $_POST['statut']) && current_user_can('administrator')) {
    $user_id = get_current_user_id();
    $paiements = maybe_unserialize(get_user_meta($user_id, 'demande_paiement', true)) ?: [];
    $paiement_id = intval($_POST['paiement_id']);

    if (isset($paiements[$paiement_id])) {
        $paiements[$paiement_id]['statut'] = sanitize_text_field($_POST['statut']);
        $paiements[$paiement_id]['paiement_date_reglement'] = ($paiements[$paiement_id]['statut'] === 'regle') ? current_time('mysql') : '';
        update_user_meta($user_id, 'demande_paiement', $paiements);
        error_log("‚úÖ Statut mis √† jour pour l'entr√©e $paiement_id : " . $paiements[$paiement_id]['statut']);
        if ($paiements[$paiement_id]['statut'] === 'regle') {
        $montant_paye = floatval($paiements[$paiement_id]['paiement_demande_montant']);
        mettre_a_jour_paiements_organisateurs($montant_paye); // üîÑ Mise √† jour des paiements aux organisateurs
        error_log("‚úÖ Paiement ajout√© aux statistiques : {$montant_paye} ‚Ç¨.");
        }   
    }
}



// ==================================================
// üì¶ R√âINITIALISATION
// ==================================================
/**
 * üîπ traiter_reinitialisation_stats ‚Üí R√©initialiser les statistiques globales du site.
 * üîπ ajouter_bouton_reinitialisation_stats ‚Üí Ajouter une option pour activer ou d√©sactiver la r√©initialisation.
 * üîπ gerer_activation_reinitialisation_stats ‚Üí G√©rer l‚Äôactivation ou la d√©sactivation de la r√©initialisation des stats.
 * üîπ supprimer_metas_organisateur ‚Üí Supprimer les m√©tadonn√©es li√©es aux organisateurs.
 * üîπ supprimer_metas_utilisateur ‚Üí Supprimer les m√©tadonn√©es des utilisateurs (optimis√©).
 * üîπ supprimer_metas_globales ‚Üí Supprimer les m√©tadonn√©es globales stock√©es dans `option_meta`.
 * üîπ supprimer_metas_post ‚Üí Supprimer les m√©tadonn√©es des √©nigmes et chasses (optimis√©).
 * üîπ supprimer_souscriptions_utilisateur ‚Üí Supprimer les souscriptions des joueurs aux √©nigmes.
 * üîπ reinitialiser_enigme ‚Üí R√©initialiser l‚Äô√©tat d‚Äôune √©nigme pour un utilisateur donn√©.
 * üîπ bouton_reinitialiser_enigme_callback ‚Üí Afficher le bouton de r√©initialisation si l‚Äôutilisateur a r√©solu l‚Äô√©nigme.
 */


/**
 * üîÑ R√©initialiser les statistiques globales du site (administrateur uniquement).
 *
 * Cette fonction est d√©clench√©e par le hook `admin_post_reset_stats_action`
 * lorsqu‚Äôun formulaire POST est soumis avec le champ `reset_stats`
 * et le nonce `reset_stats_nonce`. Elle permet de :
 *
 * 1. üßπ Supprimer toutes les m√©tadonn√©es utilisateurs li√©es aux statistiques :
 *    - total de chasses termin√©es, √©nigmes jou√©es, points d√©pens√©s/gagn√©s, etc.
 *
 * 2. üßπ Supprimer toutes les m√©tadonn√©es des posts (CPT `enigme` et `chasse`) li√©es
 *    aux tentatives, indices, progression et joueurs associ√©s.
 *
 * 3. üóë Supprimer le taux de conversion (ACF) enregistr√© dans le post `Paiements`.
 *
 * 4. üßπ Supprimer les m√©tadonn√©es globales du site et des organisateurs (via fonctions d√©di√©es).
 *
 * 5. üîß Supprimer l‚Äôoption `activer_reinitialisation_stats` pour √©viter un double d√©clenchement.
 *
 * 6. üöÄ Rediriger vers la page d‚Äôadministration d√©di√©e une fois la suppression termin√©e.
 *
 * üîê La fonction ne s‚Äôex√©cute que :
 * - en contexte admin,
 * - si l‚Äôutilisateur est administrateur,
 * - si le nonce est valide,
 * - et si l‚Äôoption `activer_reinitialisation_stats` est activ√©e.
 *
 * @return void
 *
 * @hook admin_post_reset_stats_action
 */
function traiter_reinitialisation_stats() {
    if (!is_admin() || !current_user_can('administrator')) return;
    if (!isset($_POST['reset_stats']) || !check_admin_referer('reset_stats_action', 'reset_stats_nonce')) return;
    if (!get_option('activer_reinitialisation_stats', false)) return; // V√©rification activ√©e

    error_log("üõ† D√©but de la suppression des statistiques...");

    supprimer_metas_utilisateur([
        'total_enigmes_jouees', 'total_chasses_terminees', 'total_indices_debloques',
        'total_points_depenses', 'total_points_gagnes', 'total_enigmes_trouvees'
    ]);
    supprimer_souscriptions_utilisateur();

    supprimer_metas_post('enigme', [
        'total_tentatives_enigme', 'total_indices_debloques_enigme',
        'total_points_depenses_enigme', 'total_joueurs_ayant_resolu_enigme',
        'total_joueurs_souscription_enigme', 'progression_joueurs'
    ]);

    supprimer_metas_post('chasse', [
        'total_tentatives_chasse', 'total_indices_debloques_chasse',
        'total_points_depenses_chasse', 'total_joueurs_souscription_chasse',
        'progression_joueurs'
    ]);

    // üöÄ SUPPRESSION DES TAUX DE CONVERSION ACF
    $paiements_post = get_posts([
        'post_type'      => 'administration',
        'posts_per_page' => 1,
        'title'          => 'Paiements',
        'post_status'    => 'private'
    ]);

    if (!empty($paiements_post)) {
        $post_id = $paiements_post[0]->ID;
        delete_field('taux_conversion', $post_id);
        error_log("‚úÖ Taux de conversion r√©initialis√© pour le post ID : {$post_id}");
    } else {
        error_log("‚ö†Ô∏è Aucun post 'Paiements' trouv√©, impossible de r√©initialiser les taux.");
    }
    supprimer_metas_globales();
    supprimer_metas_organisateur();


    // üîÑ D√©sactiver l'option apr√®s suppression
    delete_option('activer_reinitialisation_stats');

    error_log("‚úÖ Statistiques r√©initialis√©es avec succ√®s.");

    // ‚úÖ V√©rification du probl√®me d'√©cran blanc
    error_log("‚úÖ Fin du script, lancement de la redirection...");
    
    // V√©rifier si les headers sont d√©j√† envoy√©s
    if (!headers_sent()) {
        wp_redirect(home_url('/administration/outils/?updated=true'));
        exit;
    } else {
        error_log("‚õî Probl√®me de redirection : headers d√©j√† envoy√©s.");
        die("‚õî Probl√®me de redirection. Recharge manuelle n√©cessaire.");
    }
}
add_action('admin_post_reset_stats_action', 'traiter_reinitialisation_stats');


/**
 * ‚öôÔ∏è Affiche l'interface d'administration pour activer et d√©clencher la r√©initialisation des statistiques.
 *
 * Cette fonction g√©n√®re un bloc HTML dans une page d'administration personnalis√©e,
 * visible uniquement pour les administrateurs.
 *
 * Elle propose deux actions :
 *
 * 1. ‚úÖ Un **checkbox** pour activer ou d√©sactiver la r√©initialisation des stats, 
 *    enregistr√©e dans l'option `activer_reinitialisation_stats`.
 *
 * 2. ‚ö†Ô∏è Un **bouton de r√©initialisation** (affich√© uniquement si activ√©), qui soumet une requ√™te POST
 *    vers `admin_post_reset_stats_action` (g√©r√©e par la fonction `traiter_reinitialisation_stats()`).
 *
 * üîê La fonction est prot√©g√©e :
 * - par une v√©rification de r√¥le (`administrator`)
 * - par un nonce de s√©curit√© (`reset_stats_action`)
 *
 * üìù L'action est irr√©versible : elle supprime toutes les m√©tadonn√©es statistiques
 * li√©es aux utilisateurs, √©nigmes, chasses, et r√©glages globaux.
 *
 * @return void
 */
function ajouter_bouton_reinitialisation_stats() {
    if (!current_user_can('administrator')) return;

    $reinit_active = get_option('activer_reinitialisation_stats', false);

    ?>
    <div class="wrap">
        <h2>R√©initialisation des Statistiques</h2>
        <p>‚ö†Ô∏è <strong>Attention :</strong> Cette action est irr√©versible. Toutes les statistiques des joueurs, √©nigmes et chasses seront supprim√©es.</p>

        <form method="post">
            <?php wp_nonce_field('reset_stats_action', 'reset_stats_nonce'); ?>

            <label>
                <input type="checkbox" name="activer_reinit" value="1" <?php checked($reinit_active, true); ?>>
                Activer la r√©initialisation des statistiques
            </label>

            <br><br>
            <input type="submit" name="enregistrer_reinit" class="button button-primary" value="Enregistrer">
        </form>

        <?php if ($reinit_active): ?>
            <br>
            <form method="post">
                <?php wp_nonce_field('reset_stats_action', 'reset_stats_nonce'); ?>
                <input type="submit" name="reset_stats" class="button button-danger" value="‚ö†Ô∏è R√©initialiser toutes les statistiques" 
                       onclick="return confirm('‚ö†Ô∏è ATTENTION : Cette action est irr√©versible. Confirmez-vous la r√©initialisation ?');">
            </form>
        <?php endif; ?>
    </div>
    <?php
}

/**
 * üìå Gestion de l'activation/d√©sactivation de la r√©initialisation des stats
 */
function gerer_activation_reinitialisation_stats() {
    error_log("üõ† D√©but du traitement de l'activation/d√©sactivation");

    // ‚úÖ V√©rification des permissions administrateur
    if (!current_user_can('manage_options')) {
        error_log("‚õî Probl√®me de permission : utilisateur non autoris√©.");
        wp_die(__('‚õî Acc√®s refus√©. Vous n‚Äôavez pas la permission d‚Äôeffectuer cette action.', 'textdomain'));
    }
    error_log("üîé Permission OK");

    // ‚úÖ V√©rification de la requ√™te POST et de la s√©curit√©
    if (!isset($_POST['enregistrer_reinit']) || !check_admin_referer('toggle_reinit_stats_action', 'toggle_reinit_stats_nonce')) {
        error_log("‚õî Probl√®me de nonce ou bouton non soumis.");
        wp_die(__('‚õî Erreur de s√©curit√©. Veuillez r√©essayer.', 'textdomain'));
    }
    error_log("üîé Nonce OK");

    // ‚úÖ Mise √† jour de l'option d'activation
    $activer = isset($_POST['activer_reinit']) ? 1 : 0;
    update_option('activer_reinitialisation_stats', $activer);
    error_log("‚úÖ Option mise √† jour : " . ($activer ? 'Activ√©e' : 'D√©sactiv√©e'));

    // ‚úÖ Ajout d‚Äôun message d‚Äôalerte WordPress
    add_action('admin_notices', function() use ($activer) {
        echo '<div class="updated"><p>‚úÖ R√©initialisation des stats ' . ($activer ? 'activ√©e' : 'd√©sactiv√©e') . '.</p></div>';
    });

    // ‚úÖ V√©rification de la redirection
    $page_outils = get_page_by_path('administration/outils');
    if ($page_outils) {
        $redirect_url = get_permalink($page_outils) . '?updated=true';
    } else {
        $redirect_url = home_url('/administration/outils/?updated=true');
    }

    error_log("üîÑ Redirection vers : " . $redirect_url);
    if (!headers_sent()) {
        wp_redirect($redirect_url);
        exit;
    } else {
        error_log("‚õî Probl√®me de redirection : headers d√©j√† envoy√©s.");
    }

    exit;
}
add_action('admin_post_toggle_reinit_stats_action', 'gerer_activation_reinitialisation_stats');

/**
 * üìå Supprime les m√©ta li√©es aux organisateurs
 * - Points per√ßus par les organisateurs
 * - Historique des paiements aux organisateurs
 */
function supprimer_metas_organisateur() {
    global $wpdb;

    $meta_keys = [
        'total_points_percus_organisateur',
        'demande_paiement' // Suppression de l'historique des paiements
    ];

    // R√©cup√©ration des utilisateurs ayant un r√¥le d'organisateur
    $organisateurs = get_users([
        'role' => 'organisateur',
        'fields' => 'ID'
    ]);

    if (empty($organisateurs)) {
        error_log("‚ÑπÔ∏è Aucun organisateur trouv√©. Rien √† supprimer.");
        return;
    }

    foreach ($organisateurs as $user_id) {
        foreach ($meta_keys as $meta_key) {
            // V√©rifie si la m√©ta existe avant suppression
            $meta_existante = get_user_meta($user_id, $meta_key, true);
            if (!empty($meta_existante)) {
                if ($meta_key === 'demande_paiement') {
                    // Suppression forc√©e via SQL pour l'historique des paiements
                    $wpdb->delete($wpdb->usermeta, ['user_id' => $user_id, 'meta_key' => $meta_key]);
                    error_log("‚úÖ Suppression forc√©e via SQL pour : {$meta_key} (user_id {$user_id})");
                } else {
                    // Suppression normale pour les autres m√©ta
                    delete_user_meta($user_id, $meta_key);
                    error_log("‚úÖ Suppression r√©ussie de : {$meta_key} pour user_id {$user_id}");
                }

                // V√©rification post-suppression
                $meta_post_suppression = get_user_meta($user_id, $meta_key, true);
                if (!empty($meta_post_suppression)) {
                    error_log("‚ö†Ô∏è Probl√®me : {$meta_key} n'a pas √©t√© supprim√© pour user_id {$user_id}.");
                } else {
                    error_log("‚úÖ V√©rification OK : {$meta_key} a bien √©t√© supprim√© pour user_id {$user_id}.");
                }
            } else {
                error_log("‚ÑπÔ∏è Aucune m√©ta trouv√©e pour : {$meta_key} de user_id {$user_id}.");
            }
        }
    }
}


/**
 * üìå Suppression optimis√©e des m√©tas utilisateurs
 */
function supprimer_metas_utilisateur($meta_keys) {
    global $wpdb;
    $placeholders = implode(',', array_fill(0, count($meta_keys), '%s'));

    $wpdb->query($wpdb->prepare(
        "DELETE FROM {$wpdb->usermeta} WHERE meta_key IN ($placeholders)",
        ...$meta_keys
    ));

    // V√©rification d'erreur SQL
    if (!empty($wpdb->last_error)) {
        error_log("‚ö†Ô∏è Erreur SQL lors de la suppression des metas utilisateur : " . $wpdb->last_error);
    }
    $wpdb->query("DELETE FROM {$wpdb->usermeta} WHERE meta_key LIKE 'enigme_%_resolue'");

}

/**
 * üìå Supprime les m√©ta globales stock√©es en `option_meta`
 */
function supprimer_metas_globales() {
    $metas_globales = [
        'total_points_depenses_mois_' . date('Y_m'),
        'total_points_vendus_mensuel_' . date('Y_m'),
        'revenu_total_site',
        'revenu_total_site_mensuel_' . date('Y_m'),
        'total_paiements_effectues_mensuel_' . date('Y_m'),
        'total_points_en_circulation'
    ];

    foreach ($metas_globales as $meta) {
        delete_option($meta);
        error_log("‚úÖ Suppression r√©ussie de l'option : $meta");
    }
}

/**
 * üìå Suppression optimis√©e des m√©tas des √©nigmes et chasses
 */
function supprimer_metas_post($post_type, $meta_keys) {
    global $wpdb;

    $post_ids = get_posts([
        'post_type'      => $post_type,
        'posts_per_page' => -1,
        'fields'         => 'ids'
    ]);

    if (empty($post_ids)) {
        error_log("‚ÑπÔ∏è Aucun post trouv√© pour le type : {$post_type}. Rien √† supprimer.");
        return;
    }

    foreach ($meta_keys as $meta_key) {
        // üîç V√©rifier si la m√©ta existe avant suppression
        $existe = $wpdb->get_var($wpdb->prepare(
            "SELECT COUNT(*) FROM {$wpdb->postmeta} WHERE meta_key LIKE %s",
            $meta_key . '%'
        ));

        if ($existe > 0) {
            // üöÄ Suppression optimis√©e de toutes les variations de la m√©ta
            $wpdb->query($wpdb->prepare(
                "DELETE FROM {$wpdb->postmeta} WHERE meta_key LIKE %s",
                $meta_key . '%'
            ));
            error_log("‚úÖ Suppression r√©ussie pour : {$meta_key}%");
        } else {
            error_log("‚ÑπÔ∏è Aucune m√©ta trouv√©e pour : {$meta_key}%");
        }
    }
}

/**
 * üìå Suppression des souscriptions des joueurs aux √©nigmes
 */
function supprimer_souscriptions_utilisateur() {
    global $wpdb;

    // üöÄ Suppression de toutes les souscriptions utilisateur pour toutes les √©nigmes
    $wpdb->query("DELETE FROM {$wpdb->usermeta} WHERE meta_key LIKE 'enigme_%_souscrit'");

    if (!empty($wpdb->last_error)) {
        error_log("‚ö†Ô∏è Erreur SQL lors de la suppression des souscriptions utilisateur : " . $wpdb->last_error);
    } else {
        error_log("‚úÖ Suppression r√©ussie des souscriptions aux √©nigmes.");
    }
}

/**
 * üîÑ R√©initialise l‚Äô√©tat d‚Äôune √©nigme pour un utilisateur donn√© :
 * - Supprime le statut et la date de r√©solution.
 * - R√©initialise les indices d√©bloqu√©s.
 * - Supprime les troph√©es li√©s √† l‚Äô√©nigme et √† la chasse associ√©e.
 * - R√©initialise le statut de la chasse si n√©cessaire.
 * - Nettoie les caches li√©s √† l‚Äôutilisateur et √† l‚Äô√©nigme.
 *
 * @param int $user_id ID de l‚Äôutilisateur.
 * @param int $enigme_id ID de l‚Äô√©nigme.
 */
function reinitialiser_enigme($user_id, $enigme_id) {
    if (!is_numeric($user_id) || !is_numeric($enigme_id)) {
        error_log("‚ö†Ô∏è Param√®tres invalides : user_id={$user_id}, enigme_id={$enigme_id}");
        return;
    }

    error_log("üîÑ D√âBUT de la r√©initialisation pour l'utilisateur (ID: {$user_id}) sur l'√©nigme (ID: {$enigme_id})");

    // üßπ 1. Suppression du statut et de la date de r√©solution
    delete_user_meta($user_id, "statut_enigme_{$enigme_id}");
    delete_user_meta($user_id, "enigme_{$enigme_id}_resolution_date");
    error_log("üßπ Statut et date de r√©solution supprim√©s pour l'√©nigme (ID: {$enigme_id})");

    // üóëÔ∏è 2. R√©initialisation des indices d√©bloqu√©s
    $indices = get_field('indices', $enigme_id); 
    if (!empty($indices) && is_array($indices)) {
        foreach ($indices as $index => $indice) {
            delete_user_meta($user_id, "indice_debloque_{$enigme_id}_{$index}");
        }
        error_log("üßπ Indices d√©bloqu√©s r√©initialis√©s pour l'√©nigme (ID: {$enigme_id})");
    }

    // üèÜ 3. Suppression du troph√©e associ√© √† l‚Äô√©nigme
    $trophees_utilisateur = get_user_meta($user_id, 'trophees_utilisateur', true);
    $trophees_utilisateur = is_array($trophees_utilisateur) ? $trophees_utilisateur : [];

    $trophee_enigme = get_field('trophee_associe', $enigme_id);
    if ($trophee_enigme) {
        $trophee_enigme_id = is_array($trophee_enigme) ? reset($trophee_enigme) : $trophee_enigme;
        if (($key = array_search($trophee_enigme_id, $trophees_utilisateur)) !== false) {
            unset($trophees_utilisateur[$key]);
            update_user_meta($user_id, 'trophees_utilisateur', array_values($trophees_utilisateur));
            error_log("üèÜ Troph√©e de l'√©nigme (ID: {$trophee_enigme_id}) supprim√© pour l'utilisateur (ID: {$user_id})");
        }
    }

    // üè¥‚Äç‚ò†Ô∏è 4. Gestion de la chasse associ√©e
    $chasse_id = get_field('chasse_associee', $enigme_id, false);
    $chasse_id = is_array($chasse_id) ? reset($chasse_id) : $chasse_id;

    if ($chasse_id && is_numeric($chasse_id)) {
        // üèÜ Suppression du troph√©e associ√© √† la chasse
        $trophee_chasse = get_field('trophee_associe', $chasse_id);
        if ($trophee_chasse) {
            $trophee_chasse_id = is_array($trophee_chasse) ? reset($trophee_chasse) : $trophee_chasse;
            if (($key = array_search($trophee_chasse_id, $trophees_utilisateur)) !== false) {
                unset($trophees_utilisateur[$key]);
                update_user_meta($user_id, 'trophees_utilisateur', array_values($trophees_utilisateur));
                error_log("üèÜ Troph√©e de chasse (ID: {$trophee_chasse_id}) supprim√© pour l'utilisateur (ID: {$user_id})");
            }
        }

        // üîÑ Si la chasse est en mode "stop" et termin√©e, la remettre en cours
        $illimitee = get_field('illimitee', $chasse_id); // R√©cup√®re le mode de la chasse (stop / continue)
        $statut_chasse = get_field('statut_chasse', $chasse_id);
        
        // V√©rifie si la chasse est en mode "stop" et si elle est termin√©e
        if ($illimitee === 'stop' && in_array(mb_strtolower($statut_chasse), ['termine', 'termin√©e', 'termin√©'], true)) {
            update_field('statut_chasse', 'en cours', $chasse_id);
            update_field('gagnant', '', $chasse_id);
            update_field('date_de_decouverte', null, $chasse_id);
        
            delete_post_meta($chasse_id, 'statut_chasse');
            delete_post_meta($chasse_id, 'gagnant');
            delete_post_meta($chasse_id, 'date_de_decouverte');
        
            wp_cache_delete($chasse_id, 'post_meta');
            clean_post_cache($chasse_id);
        
            error_log("üîÑ Chasse (ID: {$chasse_id}) r√©initialis√©e : statut 'en cours', gagnant et date supprim√©s.");
        }
    }

    // üöÄ 5. (Optionnel) R√©initialisation de la souscription pour permettre de rejouer imm√©diatement
    // D√©commentez la ligne suivante si vous souhaitez que le bouton "JOUER" apparaisse directement apr√®s r√©initialisation :
    // update_user_meta($user_id, "statut_enigme_{$enigme_id}", 'souscrit');
    // error_log("üîÑ Souscription r√©initialis√©e pour l'√©nigme (ID: {$enigme_id}) ‚Üí bouton 'JOUER' r√©activ√©.");

    // üßπ 6. Nettoyage des caches
    // üöÄ 5. Rafra√Æchissement des caches WordPress pour garantir l'affichage correct
wp_cache_delete($user_id, 'user_meta'); // Supprime le cache des m√©tas utilisateur
wp_cache_delete("statut_enigme_{$enigme_id}", 'user_meta'); // Supprime le cache sp√©cifique du statut d'√©nigme
wp_cache_delete($enigme_id, 'post_meta'); // Supprime le cache des m√©tas du post (√©nigme)

clean_user_cache($user_id); // Nettoie le cache complet de l'utilisateur
clean_post_cache($enigme_id); // Nettoie le cache du post √©nigme

error_log("üîÑ Caches utilisateur et post nettoy√©s apr√®s r√©initialisation.");
error_log("‚úÖ R√©initialisation compl√®te termin√©e pour l'utilisateur (ID: {$user_id}) sur l'√©nigme (ID: {$enigme_id})");

}

/**
 * üîÑ Affiche le bouton de r√©initialisation si l'utilisateur a r√©solu l'√©nigme.
 *
 * Conditions :
 * - Affiche si le statut de l‚Äô√©nigme est "resolue" ou "terminee_resolue".
 *
 * @return string HTML du bouton ou cha√Æne vide si non applicable.
 */
function bouton_reinitialiser_enigme_callback() {
    if (!is_user_logged_in() || !is_singular('enigme') || !current_user_can('administrator')) return ''; // üö´ Restreint aux admins

    $user_id = get_current_user_id();
    $enigme_id = get_the_ID();
    $statut = enigme_get_statut($enigme_id, $user_id); // üîÑ Utilisation du statut centralis√©

    // ‚úÖ Affiche le bouton uniquement si l'√©nigme est r√©solue ou termin√©e-r√©solue
    if (!in_array($statut, ['resolue', 'terminee_resolue'])) return '';

    return "
        <form method='post' class='form-reinitialiser-enigme'>
            <button type='submit' name='reinitialiser_enigme' class='bouton-action bouton-reinitialiser dynamique-{$statut}'>
                üîÑ R√©initialiser l‚Äô√©nigme
            </button>
        </form>";
}



// ==================================================
// üõ†Ô∏è D√âVELOPPEMENT
// ==================================================
/**
 * üîπ acf_inspect_field_group ‚Üí Affiche les d√©tails d‚Äôun groupe de champs ACF dans le navigateur pour documentation manuelle.
 */


/**
 * Affiche de mani√®re lisible les d√©tails d‚Äôun groupe de champs ACF dans le navigateur.
 *
 * @param int|string $group_id_or_key L'ID ou la key du groupe de champs ACF.
 */
function acf_inspect_field_group($group_id_or_key) {
    if (!function_exists('acf_get_fields')) {
        echo '<pre>ACF non disponible.</pre>';
        return;
    }

    $group = null;
    $group_key = '';

    // Cas : ID num√©rique
    if (is_numeric($group_id_or_key)) {
        $group = get_post((int)$group_id_or_key);
        if (!$group || $group->post_type !== 'acf-field-group') {
            echo "<pre>‚ùå Aucun groupe ACF trouv√© pour l‚ÄôID {$group_id_or_key}.</pre>";
            return;
        }
        $group_key = get_post_meta($group->ID, '_acf_field_group_key', true);
        if (empty($group_key)) {
            echo "<pre>‚ùå La cl√© du groupe ACF est introuvable pour l‚ÄôID {$group->ID}.</pre>";
            return;
        }
    }

    // Cas : cl√© fournie directement
    if (!is_numeric($group_id_or_key)) {
        $group_key = $group_id_or_key;
        $group = acf_get_field_group($group_key);
        if (!$group) {
            echo "<pre>‚ùå Aucun groupe ACF trouv√© pour la key {$group_key}.</pre>";
            return;
        }
    }

    // R√©cup√©ration des champs
    $fields = acf_get_fields($group_key);
    if (empty($fields)) {
        echo "<pre>‚ö†Ô∏è Aucun champ trouv√© pour le groupe ¬´ {$group->title} ¬ª (Key : {$group_key})</pre>";
        return;
    }

    // Affichage
    echo '<pre>';
    $title = is_array($group) ? $group['title'] : $group->post_title;
    $id    = is_array($group) ? $group['ID']    : $group->ID;
    
    echo "üîπ Groupe : {$title}\n";
    echo "üÜî ID : {$id}\n";

    echo "üîë Key : {$group_key}\n";
    echo "üì¶ Champs trouv√©s : " . count($fields) . "\n\n";
    afficher_champs_acf_recursifs($fields);
    echo '</pre>';
}


/**
 * Fonction r√©cursive pour afficher les champs ACF avec indentation.
 *
 * @param array $fields Tableau de champs ACF.
 * @param int $indent Niveau d'indentation.
 */
function afficher_champs_acf_recursifs($fields, $indent = 0) {
    $prefix = str_repeat('  ', $indent);
    foreach ($fields as $field) {
        echo $prefix . "‚Äî " . $field['name'] . " ‚Äî\n";
        echo $prefix . "Type : " . $field['type'] . "\n";
        echo $prefix . "Label : " . $field['label'] . "\n";
        echo $prefix . "Instructions : " . (!empty($field['instructions']) ? $field['instructions'] : '(vide)') . "\n";
        echo $prefix . "Requis : " . ($field['required'] ? 'oui' : 'non') . "\n";

        // Options sp√©cifiques selon le type
        if (!empty($field['choices'])) {
            echo $prefix . "Choices :\n";
            foreach ($field['choices'] as $key => $label) {
                echo $prefix . "  - {$key} : {$label}\n";
            }
        }

        if (in_array($field['type'], ['repeater', 'group', 'flexible_content']) && !empty($field['sub_fields'])) {
            echo $prefix . "Contenu imbriqu√© :\n";
            afficher_champs_acf_recursifs($field['sub_fields'], $indent + 1);
        }

        echo $prefix . str_repeat('-', 40) . "\n";
    }
}
/*
| üí° Ce bloc est d√©sactiv√© par d√©faut. Il sert uniquement √† afficher
| temporairement le d√©tail d‚Äôun groupe de champs ACF dans l‚Äôinterface admin.
|
| üìã Pour l‚Äôutiliser :
|   1. D√©commente les lignes ci-dessous
|   2. Remplace l‚ÄôID (ex. : 9) par celui du groupe souhait√©
|   3. Recharge une page de l‚Äôadmin (ex : Tableau de bord)
|   4. Copie le r√©sultat affich√© et re-commente le bloc apr√®s usage
|
| ‚ùå √Ä ne jamais laisser actif en production.
*/

/*

üìã Liste des groupes ACF disponibles :
========================================

üÜî ID     : 27
üîë Key    : group_67b58c51b9a49
üè∑Ô∏è  Titre : param√®tre de la chasse
----------------------------------------
üÜî ID     : 9
üîë Key    : group_67b58134d7647
üè∑Ô∏è  Titre : Param√®tres de l‚Äô√©nigme
----------------------------------------

üÜî ID     : 657
üîë Key    : group_67c7dbfea4a39
üè∑Ô∏è  Titre : Param√®tres organisateur
----------------------------------------
üÜî ID     : 584
üîë Key    : group_67c28f6aac4fe
üè∑Ô∏è  Titre : Statistiques des chasses
----------------------------------------
üÜî ID     : 577
üîë Key    : group_67c2368625fc2
üè∑Ô∏è  Titre : Statistiques des √©nigmes
----------------------------------------
üÜî ID     : 931
üîë Key    : group_67cd4a8058510
üè∑Ô∏è  Titre : infos √©ditions chasse
----------------------------------------

add_action('admin_notices', function() {
    if (current_user_can('administrator')) {
        acf_inspect_field_group('group_67c28f6aac4fe'); // Remplacer  Key
    }
});

*/

// =============================================
// AJAX : r√©cup√©rer les d√©tails des groupes ACF
// =============================================
function recuperer_details_acf() {
    if (!current_user_can('administrator')) {
        wp_send_json_error('Non autoris√©');
    }

    // Utilisation des "keys" ACF directement car les IDs ne sont pas fiables
    // lorsque les groupes sont charg√©s via JSON local.
    $group_keys = [
        'group_67b58c51b9a49', // Param√®tre de la chasse (ID 27)
        'group_67b58134d7647', // Param√®tres de l‚Äô√©nigme (ID 9)
        'group_67c7dbfea4a39', // Param√®tres organisateur (ID 657)
    ];

    ob_start();
    foreach ($group_keys as $key) {
        acf_inspect_field_group($key);
        echo "\n";
    }
    $output = ob_get_clean();
    $output = wp_strip_all_tags($output);
    wp_send_json_success($output);
}
add_action('wp_ajax_recuperer_details_acf', 'recuperer_details_acf');


/**
 * Charge le script de la carte D√©veloppement sur la page Mon Compte
 */
function charger_script_developpement_card() {
    if (is_page('mon-compte') && current_user_can('administrator')) {
        wp_enqueue_script(
            'developpement-card',
            get_stylesheet_directory_uri() . '/assets/js/developpement-card.js',
            [],
            filemtime(get_stylesheet_directory() . '/assets/js/developpement-card.js'),
            true
        );
        wp_localize_script('developpement-card', 'ajax_object', [
            'ajax_url' => admin_url('admin-ajax.php')
        ]);
    }
}
add_action('wp_enqueue_scripts', 'charger_script_developpement_card');

// ==================================================
// üì¶ TABLEAU ORGANISATEURS EN CR√âATION
// ==================================================
/**
 * R√©cup√®re la liste des organisateurs en cours de cr√©ation.
 *
 * @return array[] Tableau des donn√©es tri√© du plus r√©cent au plus ancien.
 */
function recuperer_organisateurs_en_creation() {
    if (!current_user_can('administrator')) {
        return [];
    }

    $users   = get_users(['role' => 'organisateur_creation']);
    $entries = [];

    foreach ($users as $user) {
        $organisateur_id = get_organisateur_from_user($user->ID);
        if (!$organisateur_id) {
            continue;
        }

        $date_creation = get_post_field('post_date', $organisateur_id);
        $chasses       = get_chasses_en_creation($organisateur_id);
        if (empty($chasses)) {
            continue;
        }

        $chasse     = $chasses[0];
        $nb_enigmes = count(recuperer_enigmes_associees($chasse->ID));

        $entries[] = [
            'date_creation'      => $date_creation,
            'organisateur_titre' => get_the_title($organisateur_id),
            'chasse_id'          => $chasse->ID,
            'chasse_titre'       => get_the_title($chasse->ID),
            'nb_enigmes'         => $nb_enigmes,
        ];
    }

    usort($entries, function ($a, $b) {
        return strtotime($b['date_creation']) <=> strtotime($a['date_creation']);
    });

    return $entries;
}

/**
 * Affiche les tableaux des organisateurs en cr√©ation.
 */
function afficher_tableau_organisateurs_en_creation() {
    $liste = recuperer_organisateurs_en_creation();
    if (empty($liste)) {
        echo '<p>Aucun organisateur en cr√©ation.</p>';
        return;
    }

    echo '<table class="stats-table"><tbody>';

    foreach ($liste as $entry) {
        echo '<tr>';
        echo '<td>' . esc_html($entry['organisateur_titre']) . '</td>';
        echo '<td><a href="' . esc_url(get_permalink($entry['chasse_id'])) . '">' . esc_html($entry['chasse_titre']) . '</a></td>';
        echo '<td>' . intval($entry['nb_enigmes']) . ' √©nigmes</td>';
        echo '</tr>';
    }
    echo '</tbody></table>';

    $oldest = end($liste);
    echo '<table class="stats-table">';
    echo '<caption>+ Ancienne cr√©ation</caption><tbody>';
    echo '<tr>';
    echo '<td>' . esc_html($oldest['organisateur_titre']) . '</td>';
    echo '<td><a href="' . esc_url(get_permalink($oldest['chasse_id'])) . '">' . esc_html($oldest['chasse_titre']) . '</a></td>';
    echo '<td>' . intval($oldest['nb_enigmes']) . ' √©nigmes</td>';
    echo '</tr></tbody></table>';
}
