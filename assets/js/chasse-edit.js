// ‚úÖ chasse-edit.js
console.log('‚úÖ chasse-edit.js charg√©');

let inputDateDebut;
let inputDateFin;
let erreurDebut;
let erreurFin;
let checkboxIllimitee;
let ancienneValeurDebut = '';
let ancienneValeurFin = '';


document.addEventListener('DOMContentLoaded', () => {
    inputDateDebut = document.getElementById('chasse-date-debut');
    inputDateFin = document.getElementById('chasse-date-fin');
    erreurDebut = document.getElementById('erreur-date-debut');
    erreurFin = document.getElementById('erreur-date-fin');
    checkboxIllimitee = document.getElementById('duree-illimitee');


  // ==============================
  // üü¢ Initialisation des champs
  // ==============================
  document.querySelectorAll('.champ-chasse[data-champ]').forEach((bloc) => {
    const champ = bloc.dataset.champ;

    if (bloc.classList.contains('champ-img')) {
      if (typeof initChampImage === 'function') initChampImage(bloc);
    } else if (champ === 'chasse_principale_liens') {
      const bouton = bloc.querySelector('.champ-modifier');
      if (bouton && typeof initLiensChasse === 'function') initLiensChasse(bloc);
    } else {
      if (typeof initChampTexte === 'function') initChampTexte(bloc);
    }
  });

  // ==============================
  // üß∞ D√©clencheurs de r√©sum√©
  // ==============================
  document.querySelectorAll('.edition-panel-chasse .champ-modifier[data-champ]').forEach((btn) => {
    if (typeof initChampDeclencheur === 'function') initChampDeclencheur(btn);
  });

  // ==============================
  // üõ†Ô∏è Contr√¥les panneau principal
  // ==============================
  document.getElementById('toggle-mode-edition-chasse')?.addEventListener('click', () => {
    document.body.classList.toggle('edition-active-chasse');
  });
  document.querySelector('.edition-panel-chasse .panneau-fermer')?.addEventListener('click', () => {
    document.body.classList.remove('edition-active-chasse');
    document.activeElement?.blur();
  });

  // ==============================
  // üìú Panneau description (wysiwyg)
  // ==============================
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.ouvrir-panneau-description');
    if (!btn || btn.dataset.cpt !== 'chasse') return;
    const panneau = document.getElementById('panneau-description-chasse');
    if (!panneau) return;

    document.querySelectorAll('.panneau-lateral.ouvert, .panneau-lateral-liens.ouvert').forEach((p) => {
      p.classList.remove('ouvert');
      p.setAttribute('aria-hidden', 'true');
    });

    panneau.classList.add('ouvert');
    document.body.classList.add('panneau-ouvert');
    panneau.setAttribute('aria-hidden', 'false');
  });
  document.querySelector('#panneau-description-chasse .panneau-fermer')?.addEventListener('click', () => {
    const panneau = document.getElementById('panneau-description-chasse');
    panneau.classList.remove('ouvert');
    document.body.classList.remove('panneau-ouvert');
    panneau.setAttribute('aria-hidden', 'true');
  });

  // ==============================
  // üè± Panneau r√©compense
  // ==============================
  document.addEventListener('click', (e) => {
      const btn = e.target.closest('.ouvrir-panneau-recompense');
      if (!btn || btn.dataset.cpt !== 'chasse') return;
      const panneau = document.getElementById('panneau-recompense-chasse');
      if (!panneau) return;
    
      document.querySelectorAll('.panneau-lateral.ouvert, .panneau-lateral-liens.ouvert').forEach((p) => {
        p.classList.remove('ouvert');
        p.setAttribute('aria-hidden', 'true');
      });
    
      panneau.classList.add('ouvert');
      document.body.classList.add('panneau-ouvert');
      panneau.setAttribute('aria-hidden', 'false');
    
    });
  document.querySelector('#panneau-recompense-chasse .panneau-fermer')?.addEventListener('click', () => {
    const panneau = document.getElementById('panneau-recompense-chasse');
    panneau.classList.remove('ouvert');
    document.body.classList.remove('panneau-ouvert');
    panneau.setAttribute('aria-hidden', 'true');
  });

  // ==============================
  // üéØ Badge dynamique r√©compense
  // ==============================
  if (typeof window.mettreAJourResumeInfos === 'function') {
    window.mettreAJourResumeInfos();
  }

    // ==============================
    // üìÖ Gestion Date de fin + Dur√©e illimit√©e
    // ==============================
    let ancienneValeurFin = '';
    if (inputDateFin) {
        let ancienneValeurFin = inputDateFin.value;
        
          if (checkboxIllimitee) {
              inputDateFin.disabled = checkboxIllimitee.checked;
            
              const postId = inputDateFin.closest('.champ-chasse')?.dataset.postId;
            
              checkboxIllimitee.addEventListener('change', function () {
                inputDateFin.disabled = this.checked;
            
                // Si la case est d√©coch√©e et les dates incoh√©rentes, corriger la date de fin
                if (!this.checked) {
                  const debut = new Date(inputDateDebut.value);
                  const fin = new Date(inputDateFin.value);
            
                  if (!isNaN(debut) && !isNaN(fin) && debut >= fin) {
                    const nouvelleDateFin = new Date(debut);
                    nouvelleDateFin.setFullYear(nouvelleDateFin.getFullYear() + 2);
            
                    const yyyy = nouvelleDateFin.getFullYear();
                    const mm = String(nouvelleDateFin.getMonth() + 1).padStart(2, '0');
                    const dd = String(nouvelleDateFin.getDate()).padStart(2, '0');
            
                    const nouvelleValeur = `${yyyy}-${mm}-${dd}`;
                    inputDateFin.value = nouvelleValeur;
                    
                    fetch(ajaxurl, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                      body: new URLSearchParams({
                        action: 'modifier_champ_chasse',
                        champ: 'caracteristiques.chasse_infos_date_fin',
                        valeur: nouvelleValeur,
                        post_id: postId
                      })
                    })
                    .then(r => r.json())
                    .then(res => {
                      if (!res.success) {
                        console.error('‚ùå Erreur lors de l‚Äôenregistrement de la date de fin auto-corrig√©e');
                      }
                    });
                    rafraichirStatutChasse(postId);
                  }
                }
            
                // Enregistrement de la case "illimit√©"
                fetch(ajaxurl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                  body: new URLSearchParams({
                    action: 'modifier_champ_chasse',
                    champ: 'caracteristiques.chasse_infos_duree_illimitee',
                    valeur: this.checked ? 1 : 0,
                    post_id: postId
                  })
                })
                .then(r => r.json())
                .then(res => {
                  if (res.success) {
                    rafraichirStatutChasse(postId);
                  } else {
                    console.error('‚ùå Erreur serveur dur√©e illimit√©e:', res.data);
                  }
                })
                .catch(err => {
                  console.error('‚ùå Erreur r√©seau dur√©e illimit√©e:', err);
                });
            
                mettreAJourAffichageDateFin();
              });
          }

        inputDateFin.addEventListener('change', function () {
          const sauvegardeAvantChangement = this.value;
        
          const valid = validerDatesAvantEnvoi('fin');
          if (!valid) {
            this.value = ancienneValeurFin;
            return;
          }
        
          const nouvelleDateFin = this.value;
          const regexDate = /^\d{4}-\d{2}-\d{2}$/;
        
          if (!regexDate.test(nouvelleDateFin)) {
            console.error('‚ùå Format de date fin invalide:', nouvelleDateFin);
            this.value = ancienneValeurFin;
            return;
          }
        
          const postId = this.closest('.champ-chasse')?.dataset.postId;
          modifierChampSimple('caracteristiques.chasse_infos_date_fin', nouvelleDateFin, postId);
          rafraichirStatutChasse(postId);
        
          mettreAJourAffichageDateFin();
        
          ancienneValeurFin = nouvelleDateFin;
        });
    }
    if (inputDateDebut) {
      ancienneValeurDebut = inputDateDebut.value;
    
      inputDateDebut.addEventListener('change', function () {
        const nouvelleDateDebut = this.value;
        const regexDate = /^\d{4}-\d{2}-\d{2}$/;
    
        if (!regexDate.test(nouvelleDateDebut)) {
          console.error('‚ùå Format de date d√©but invalide:', nouvelleDateDebut);
          this.value = ancienneValeurDebut;
          return;
        }
    
        const postId = this.closest('.champ-chasse')?.dataset.postId;
        modifierChampSimple('caracteristiques.chasse_infos_date_debut', nouvelleDateDebut, postId);
        rafraichirStatutChasse(postId);
    
        ancienneValeurDebut = nouvelleDateDebut;
      });
    }

    
    
    // ================================
    // üèÜ Gestion de l'enregistrement de la r√©compense (titre, texte, valeur)
    // ================================
    const boutonRecompense = document.getElementById('bouton-enregistrer-recompense');
    const inputTitreRecompense = document.getElementById('champ-recompense-titre');
    const inputTexteRecompense = document.getElementById('champ-recompense-texte');
    const inputValeurRecompense = document.getElementById('champ-recompense-valeur');
    const panneauRecompense = document.getElementById('panneau-recompense-chasse');
    const boutonSupprimerRecompense = document.getElementById('bouton-supprimer-recompense');

    if (boutonSupprimerRecompense) {
      boutonSupprimerRecompense.addEventListener('click', () => {
  const panneauEdition = document.querySelector('.edition-panel-chasse');
  if (!panneauEdition) return;
  const postId = panneauEdition.dataset.postId;
  if (!postId) return;

  if (!confirm('Voulez-vous vraiment supprimer la r√©compense ?')) return;

  const champsASupprimer = [
    'caracteristiques.chasse_infos_recompense_titre',
    'caracteristiques.chasse_infos_recompense_texte',
    'caracteristiques.chasse_infos_recompense_valeur'
  ];

  Promise.all(
    champsASupprimer.map((champ) => {
      return fetch(ajaxurl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          action: 'modifier_champ_chasse',
          champ,
          valeur: '',
          post_id: postId
        })
      });
    })
  ).then(() => {
    location.reload();
  });
});

    }

    
    if (boutonRecompense && inputTitreRecompense && inputTexteRecompense && inputValeurRecompense) {
      boutonRecompense.addEventListener('click', () => {
          const titre = inputTitreRecompense.value.trim();
          const texte = inputTexteRecompense.value.trim();
          const valeur = parseFloat(inputValeurRecompense.value);
          const panneauEdition = document.querySelector('.edition-panel-chasse');
          if (!panneauEdition) return;
          const postId = panneauEdition.dataset.postId;
          if (!postId) return;
        
          // üö® V√©rification des 3 champs
          if (!titre.length) {
            alert('Veuillez saisir un titre de r√©compense.');
            return;
          }
        
          if (!texte.length) {
            alert('Veuillez saisir une description de r√©compense.');
            return;
          }
        
          if (isNaN(valeur) || valeur <= 0) {
            alert('Veuillez saisir une valeur en euros strictement sup√©rieure √† 0.');
            return;
          }
    
        // üîµ Envoi titre de r√©compense d'abord
        fetch('/wp-admin/admin-ajax.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            action: 'modifier_champ_chasse',
            champ: 'caracteristiques.chasse_infos_recompense_titre',
            valeur: titre,
            post_id: postId
          })
        })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            console.log('‚úÖ Titre r√©compense enregistr√©.');
    
            // üîµ Ensuite, envoi texte r√©compense
            return fetch('/wp-admin/admin-ajax.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({
                action: 'modifier_champ_chasse',
                champ: 'caracteristiques.chasse_infos_recompense_texte',
                valeur: texte,
                post_id: postId
              })
            });
          } else {
            throw new Error('Erreur enregistrement titre r√©compense');
          }
        })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            console.log('‚úÖ Texte r√©compense enregistr√©.');
    
            // üîµ Ensuite, envoi valeur r√©compense
            return fetch('/wp-admin/admin-ajax.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({
                action: 'modifier_champ_chasse',
                champ: 'caracteristiques.chasse_infos_recompense_valeur',
                valeur: valeur,
                post_id: postId
              })
            });
          } else {
            throw new Error('Erreur enregistrement texte r√©compense');
          }
        })
        .then(r => r.json())
        .then(res => {
          if (res.success) {
            if (typeof window.mettreAJourResumeInfos === 'function') {
              window.mettreAJourResumeInfos();
            }
        
            if (document.activeElement && panneauRecompense.contains(document.activeElement)) {
              document.activeElement.blur();
              document.body.focus(); // üî• Correction ultime ici
            }
        
            location.reload();
        
          } else {
            console.error('‚ùå Erreur valeur r√©compense', res.data);
          }
        })
        .catch(err => {
          console.error('‚ùå Erreur sur sauvegarde r√©compense', err);
        });
      });
    }
});


// ==============================
// üîó Initialisation des liens chasse
// ==============================
function initLiensChasse(bloc) {
  const champ = bloc.dataset.champ;
  const postId = bloc.dataset.postId;
  const bouton = bloc.querySelector('.champ-modifier.ouvrir-panneau-liens');
  const panneau = document.getElementById('panneau-liens-chasse');
  let formulaire = document.getElementById('formulaire-liens-chasse');
  const feedback = bloc.querySelector('.champ-feedback');

  if (!champ || !postId || !formulaire || !bouton || !panneau) return;

  bouton.addEventListener('click', () => {
    document.querySelectorAll('.panneau-lateral.ouvert, .panneau-lateral-liens.ouvert').forEach((p) => {
      p.classList.remove('ouvert');
      p.setAttribute('aria-hidden', 'true');
    });
    panneau.classList.add('ouvert');
    document.body.classList.add('panneau-ouvert');
    panneau.setAttribute('aria-hidden', 'false');
  });

  panneau.querySelector('.panneau-fermer')?.addEventListener('click', () => {
    panneau.classList.remove('ouvert');
    document.body.classList.remove('panneau-ouvert');
    panneau.setAttribute('aria-hidden', 'true');
  });

  const clone = formulaire.cloneNode(true);
  formulaire.replaceWith(clone);
  formulaire = clone;

  formulaire.addEventListener('submit', (e) => {
    e.preventDefault();
    e.stopPropagation();

    const lignes = formulaire.querySelectorAll('.ligne-lien-formulaire');
    const donnees = [];

    lignes.forEach((ligne) => {
      const type = ligne.dataset.type;
      const input = ligne.querySelector('input[type="url"]');
      const url = input?.value.trim();
      if (type && url) {
        try {
          new URL(url);
          donnees.push({ type_de_lien: type, url_lien: url });
        } catch (_) {
          input.classList.add('champ-erreur');
        }
      }
    });

    fetch('/wp-admin/admin-ajax.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'modifier_champ_chasse',
        champ,
        post_id: postId,
        valeur: JSON.stringify(donnees)
      })
    })
      .then(res => res.json())
      .then((res) => {
        if (!res.success) throw new Error(res.data || 'Erreur AJAX');

        // Met √† jour les donn√©es en local dans le panneau
        const champDonnees = bloc.querySelector('.champ-donnees');
        if (champDonnees) {
          champDonnees.dataset.valeurs = JSON.stringify(donnees);
        }

        // Met √† jour l'affichage dans la fiche publique (pas le panneau)
        const blocFiche = document.querySelector(
          `.champ-chasse.champ-fiche-publication[data-champ="${champ}"][data-post-id="${postId}"]`
        );
        const affichageFiche = blocFiche?.querySelector('.champ-affichage');
        if (affichageFiche && typeof renderLiensPublicsJS === 'function') {
          affichageFiche.innerHTML = renderLiensPublicsJS(donnees);
          
        
          // üîÅ Relance la d√©tection de compl√©tion (liens d√©tect√©s apr√®s rendu)
          if (typeof window.mettreAJourResumeInfos === 'function') {
            window.mettreAJourResumeInfos();
          }
        }

        // Classe remplie/vide
        bloc.classList.toggle('champ-vide', donnees.length === 0);
        bloc.classList.toggle('champ-rempli', donnees.length > 0);

        panneau.classList.remove('ouvert');
        document.body.classList.remove('panneau-ouvert');
        panneau.setAttribute('aria-hidden', 'true');

        if (typeof window.mettreAJourResumeInfos === 'function') {
          window.mettreAJourResumeInfos();
        }
      })
      .catch((err) => {
        console.error('‚ùå AJAX fail', err.message || err);
        if (feedback) {
          feedback.textContent = 'Erreur : ' + (err.message || 'Serveur ou r√©seau.');
          feedback.className = 'champ-feedback champ-error';
        }
      });
  });
}


// ==============================
// üîé Validation logique entre date de d√©but et date de fin
// ==============================
function validerDatesAvantEnvoi(champModifie) {
  // ‚úÖ Si illimit√©, on n'applique aucun contr√¥le
  if (checkboxIllimitee?.checked) return true;

  if (erreurDebut) erreurDebut.style.display = 'none';
  if (erreurFin) erreurFin.style.display = 'none';

  if (!inputDateDebut || !inputDateFin) return true;

  const maintenant = new Date();
  const dateMinimum = new Date();
  dateMinimum.setFullYear(maintenant.getFullYear() - 10);
  const dateMaximum = new Date();
  dateMaximum.setFullYear(dateMaximum.getFullYear() + 5);

  const debut = new Date(inputDateDebut.value);
  const fin = new Date(inputDateFin.value);

  if (debut < dateMinimum || debut > dateMaximum) {
    if (champModifie === 'debut' && erreurDebut) {
      erreurDebut.textContent = '‚ùå La date de d√©but est trop ancienne (10 ans maximum d\'anciennet√©).';
      erreurDebut.style.display = 'block';
      afficherErreurGlobale('‚ùå La date de d√©but est trop ancienne (10 ans maximum d\'anciennet√©).');
    }
    return false;
  }

  if (isNaN(debut.getTime()) && champModifie === 'debut') {
    if (erreurDebut) {
      erreurDebut.textContent = '‚ùå Date de d√©but invalide.';
      erreurDebut.style.display = 'block';
      afficherErreurGlobale('‚ùå Date de d√©but invalide.');
    }
    return false;
  }

  if (isNaN(fin.getTime()) && champModifie === 'fin') {
    if (erreurFin) {
      erreurFin.textContent = '‚ùå Date de fin invalide.';
      erreurFin.style.display = 'block';
      afficherErreurGlobale('‚ùå Date de fin invalide.');
    }
    return false;
  }

  if (debut.getTime() >= fin.getTime()) {
    const msg = '‚ùå La date de d√©but doit √™tre ant√©rieure √† la date de fin.';
    if (champModifie === 'debut' && erreurDebut) {
      erreurDebut.textContent = msg;
      erreurDebut.style.display = 'block';
      afficherErreurGlobale(msg);
    }
    if (champModifie === 'fin' && erreurFin) {
      erreurFin.textContent = msg;
      erreurFin.style.display = 'block';
      afficherErreurGlobale(msg);
    }
    return false;
  }

  return true;
}


// ==============================
// üî• Affichage d'un message global temporaire
// ==============================
function afficherErreurGlobale(message) {
  const erreurGlobal = document.getElementById('erreur-global');
  if (!erreurGlobal) return;

  erreurGlobal.textContent = message;
  erreurGlobal.style.display = 'block';
  erreurGlobal.style.position = 'fixed';
  erreurGlobal.style.top = '0';
  erreurGlobal.style.left = '0';
  erreurGlobal.style.width = '100%';
  erreurGlobal.style.zIndex = '9999';

  setTimeout(() => {
    erreurGlobal.style.display = 'none';
  }, 4000); // Disparition apr√®s 4 secondes
}


// ================================
// üí∞ Mise √† jour dynamique de l'affichage du co√ªt (Gratuit / Payant)
// ================================
function mettreAJourAffichageCout(postId, cout) {
  const coutAffichage = document.querySelector(`.chasse-prix[data-post-id="${postId}"] .cout-affichage`);
  if (!coutAffichage) return;

  coutAffichage.dataset.cout = cout; // Met √† jour data-cout
  coutAffichage.innerHTML = ''; // Vide l'affichage

  const templateId = parseInt(cout, 10) === 0 ? 'icon-free' : 'icon-unlock';
  const template = document.getElementById(templateId);

  if (template) {
    coutAffichage.appendChild(template.content.cloneNode(true));
  }

  if (parseInt(cout, 10) === 0) {
    coutAffichage.insertAdjacentText('beforeend', ' Gratuit');
  } else {
    coutAffichage.insertAdjacentText('beforeend', ` ${cout}`);
    const devise = document.createElement('span');
    devise.className = 'prix-devise';
    devise.textContent = 'pts';
    coutAffichage.appendChild(devise);
  }
}


// ================================
// üíæ Enregistrement du co√ªt en points apr√®s clic bouton "‚úì"
// ================================
document.querySelectorAll('.champ-cout-points .champ-enregistrer').forEach(bouton => {
  bouton.addEventListener('click', (e) => {
    e.preventDefault();
    const li = bouton.closest('li');
    const input = li.querySelector('.champ-input');
    if (!li || !input) return;

    const champ = li.dataset.champ;
    const postId = li.dataset.postId;
    const valeur = input.value.trim() === '' ? '0' : input.value.trim();

    if (!champ || !postId) return;

    modifierChampSimple(champ, valeur, postId);

    if (champ === 'caracteristiques.chasse_infos_cout_points') {
        mettreAJourAffichageCout(postId, valeur);
        rafraichirStatutChasse(postId);
    }

    // Cache les boutons apr√®s envoi
    const boutons = li.querySelector('.champ-inline-actions');
    if (boutons) {
      boutons.style.opacity = '0';
      boutons.style.visibility = 'hidden';
      input.dataset.valeurInitiale = valeur;
    }
  });
});



// ================================
// üí∞ Gestion de l'enregistrement du co√ªt en points
// ================================
document.querySelectorAll('.champ-cout-points .champ-annuler').forEach(bouton => {
  bouton.addEventListener('click', (e) => {
    e.preventDefault();
    const li = bouton.closest('li');
    const input = li.querySelector('.champ-input');
    if (!li || !input) return;

    // Restaure l'ancienne valeur
    input.value = input.dataset.valeurInitiale || '0';

    // Cache les boutons
    const boutons = li.querySelector('.champ-inline-actions');
    if (boutons) {
      boutons.style.opacity = '0';
      boutons.style.visibility = 'hidden';
    }
  });
});



// ================================
// üéØ Gestion du champ Nombre de gagnants + Illimit√© (avec debounce)
// ================================
function initChampNbGagnants() {
  const inputNb = document.getElementById('chasse-nb-gagnants');
  const checkboxIllimite = document.getElementById('nb-gagnants-illimite');

  if (!inputNb || !checkboxIllimite) return;

  let timerDebounce;

  checkboxIllimite.addEventListener('change', function () {
    const postId = inputNb.closest('li').dataset.postId;
    if (!postId) return;

    if (checkboxIllimite.checked) {
      inputNb.disabled = true;
      inputNb.value = '0';
      modifierChampSimple('caracteristiques.chasse_infos_nb_max_gagants', 0, postId);
    } else {
      inputNb.disabled = false;
      if (parseInt(inputNb.value.trim(), 10) === 0 || inputNb.value.trim() === '') {
        inputNb.value = '1';
        modifierChampSimple('caracteristiques.chasse_infos_nb_max_gagants', 1, postId);
      }
    }
    // üî• Mise √† jour dynamique apr√®s changement illimit√©
    mettreAJourAffichageNbGagnants(postId, inputNb.value.trim());
  });

  inputNb.addEventListener('input', function () {
      const postId = inputNb.closest('li').dataset.postId;
      if (!postId) return;
    
      clearTimeout(timerDebounce);
      timerDebounce = setTimeout(() => {
        let valeur = parseInt(inputNb.value.trim(), 10);
        if (isNaN(valeur) || valeur < 1) {
          valeur = 1;
          inputNb.value = '1';
        }
        modifierChampSimple('caracteristiques.chasse_infos_nb_max_gagants', valeur, postId);
        mettreAJourAffichageNbGagnants(postId, valeur); // ‚úÖ ici, APRES avoir d√©fini valeur
      }, 500);
    });
}

// √Ä appeler :
initChampNbGagnants();


// ================================
// üë• Mise √† jour dynamique de l'affichage du nombre de gagnants
// ================================
function mettreAJourAffichageNbGagnants(postId, nb) {
  const nbGagnantsAffichage = document.querySelector(`.nb-gagnants-affichage[data-post-id="${postId}"]`);
  if (!nbGagnantsAffichage) return;

  if (parseInt(nb, 10) === 0) {
    nbGagnantsAffichage.textContent = 'Nombre illimit√© de gagnants';
  } else {
    nbGagnantsAffichage.textContent = `${nb} gagnant${nb > 1 ? 's' : ''}`;
  }
}



document.addEventListener('acf/submit_success', function(e) {
  console.log('‚úÖ Formulaire ACF soumis avec succ√®s', e);
  if (typeof window.mettreAJourResumeInfos === 'function') {
    window.mettreAJourResumeInfos();
  }
});


// ================================
// üîÅ Rafra√Æchissement dynamique du statut de la chasse
// ================================
function rafraichirStatutChasse(postId) {
  if (!postId) return;

  fetch(ajaxurl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      action: 'forcer_recalcul_statut_chasse',
      post_id: postId
    })
  })
  .then(res => res.json())
  .then(stat => {
    if (!stat.success) {
      console.warn('‚ö†Ô∏è √âchec recalcul statut chasse', stat);
      return;
    }

    fetch(ajaxurl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'recuperer_statut_chasse',
        post_id: postId
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success && data.data?.statut) {
        const statut = data.data.statut;
        const label = data.data.statut_label;
        const badge = document.querySelector(`.badge-statut[data-post-id="${postId}"]`);
        console.log('üîé Badge trouv√© :', badge);

        if (badge) {
          badge.textContent = label;
          badge.className = `badge-statut statut-${statut}`;
        } else {
          console.warn('‚ùì Aucun badge-statut trouv√© pour postId', postId);
        }
      } else {
        console.warn('‚ö†Ô∏è Donn√©es statut invalides', data);
      }
    })
    .catch(err => {
      console.error('‚ùå Erreur r√©seau r√©cup√©ration statut chasse', err);
    });
  })
  .catch(err => {
    console.error('‚ùå Erreur r√©seau recalcul statut chasse', err);
  });
}


// ==============================
// üß© Hook de post-traitement apr√®s modification d‚Äôun champ simple
// ==============================
window.onChampSimpleMisAJour = function (champ, postId, valeur, cpt) {
  if (cpt !== 'chasse') return;

  const champsQuiDoiventRafraichir = [
    'caracteristiques.chasse_infos_date_debut',
    'caracteristiques.chasse_infos_date_fin',
    'caracteristiques.chasse_infos_duree_illimitee',
    'caracteristiques.chasse_infos_cout_points',
    'champs_caches.chasse_cache_statut',
    'champs_caches.chasse_cache_statut_validation'
  ];

  if (champsQuiDoiventRafraichir.includes(champ)) {
    console.log('üìõ Recalcul dynamique requis ‚Üí', champ);
    rafraichirStatutChasse(postId);
  }
};
